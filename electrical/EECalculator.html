<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Electrical Engineering Calculator</title>
    <link rel="icon" type="image/png" href="../assets/logo.png">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          integrity="sha512-pf1QYhZBRU4Caxljw2E1KaQe7bVz+E6B9uC2r5VDTP6zTyrZkW9F+19KTpoTpPpVfAPjz7hH5cBqyk4PU8s5cQ==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- MathJax for Formulas -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298, #2980b9, #6dd5ed);
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            transition: background 0.5s ease;
        }
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50, #34495e, #4a69bd, #55aefc);
            color: #ecf0f1;
        }

        /* Header Styles */
        header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative; /* For absolute positioning of home and theme toggle */
            padding: 10px 20px;
            background-color: rgba(44, 62, 80, 0.8);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        /* Home Button */
        header a {
            position: absolute;
            left: 20px;
            text-decoration: none;
            color: #f1c40f;
            font-size: 1.5rem;
            transition: color 0.3s;
        }
        header a:hover {
            color: #ecf0f1;
        }
        /* Title */
        header h1 {
            font-size: 2rem;
            color: #f1c40f;
            text-shadow: 1px 1px 5px rgba(0,0,0,0.3);
            text-align: center;
        }
        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            right: 20px;
            cursor: pointer;
            color: #f1c40f;
            font-size: 1.5rem;
            transition: color 0.3s;
        }
        .theme-toggle:hover {
            color: #e67e22;
        }

        /* Calculation Buttons */
        .calculation-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 1000px;
            margin-bottom: 20px;
        }
        .category {
            background-color: rgba(44, 62, 80, 0.9);
            padding: 15px;
            border-radius: 8px;
        }
        .category h2 {
            font-size: 1.5rem;
            color: #f1c40f;
            margin-bottom: 10px;
        }
        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .calc-btn {
            padding: 10px 20px;
            background-color: #34495e;
            color: #ecf0f1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .calc-btn:hover {
            background-color: #2c3e50;
            transform: translateY(-2px);
        }
        .calc-btn.active {
            background-color: #f1c40f;
            color: #34495e;
        }

        /* Main Calculator Container */
        .calculator-container {
            width: 100%;
            max-width: 800px;
            background-color: rgba(44, 62, 80, 0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center; /* Center contents horizontally */
        }

        /* Input Fields */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%; /* Ensure inputs take full width */
        }
        .input-group label {
            font-size: 1rem;
            color: #f1c40f;
        }
        .input-group input {
            padding: 10px 15px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            background-color: #2c3e50;
            color: #ecf0f1;
            transition: background-color 0.3s, box-shadow 0.3s;
            width: 100%; /* Ensure inputs take full width */
        }
        .input-group input:focus {
            background-color: #34495e;
            box-shadow: inset 0 0 5px #f39c12;
            outline: none;
        }

        /* Result and Formula Display */
        .result-container {
            background-color: #2c3e50;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center; /* Center contents horizontally */
            width: 100%;
        }
        .result-container strong {
            font-size: 1.1rem;
            color: #f1c40f;
        }
        .result {
            font-size: 2rem; /* Increased font size */
            color: #2ecc71;
            font-weight: bold;
            text-align: center; /* Center the text */
        }
        .formula {
            font-size: 1.5rem; /* Increased font size */
            color: #ecf0f1;
            font-family: 'Courier New', Courier, monospace;
            text-align: center; /* Center the text */
            max-width: 100%; /* Ensure formula doesn't overflow */
        }

        /* Save to Favorites Button */
        .save-favorite-btn {
            padding: 10px 20px;
            background-color: #e67e22;
            color: #ecf0f1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .save-favorite-btn:hover {
            background-color: #d35400;
            transform: translateY(-2px);
        }

        /* Add/Remove Resistor Buttons */
        .resistor-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .add-resistor-btn, .remove-resistor-btn {
            padding: 5px 10px;
            background-color: #2980b9;
            color: #ecf0f1;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 0.9rem;
        }
        .add-resistor-btn:hover, .remove-resistor-btn:hover {
            background-color: #1f6391;
            transform: translateY(-2px);
        }

        /* Additional Sections: Favorites and History */
        .additional-sections {
            display: flex;
            gap: 40px; /* Increased gap for better spacing */
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 1200px;
            margin-top: 30px; /* Added margin-top to separate from calculator */
        }
        .section {
            flex: 1;
            min-width: 250px;
            background-color: rgba(44, 62, 80, 0.8);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .section strong {
            font-size: 1.2rem;
            color: #f1c40f;
            margin-bottom: 10px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .section ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .section ul li {
            background-color: #34495e;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .section ul li:hover {
            background-color: #2c3e50;
            transform: translateY(-2px);
        }
        .section ul li .info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .section ul li .info span {
            font-size: 0.9rem;
            color: #bdc3c7;
        }
        .section ul li i {
            color: #f1c40f;
        }
        .section ul li .remove-btn {
            background-color: transparent;
            border: none;
            color: #e74c3c;
            font-size: 1rem;
            cursor: pointer;
            display: none;
        }
        .section ul li:hover .remove-btn {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .additional-sections {
                flex-direction: column;
                align-items: center;
            }
        }
        @media (max-width: 600px) {
            header h1 {
                font-size: 1.5rem;
            }
            .calc-btn, .save-favorite-btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            .result {
                font-size: 1.5rem; /* Adjusted for smaller screens */
            }
            .formula {
                font-size: 1.2rem; /* Adjusted for smaller screens */
            }
            .section {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <!-- Home Button -->
        <a href="../index.html" title="Go Back">
            <i class="fa-solid fa-house"></i>
        </a>
        <!-- Title -->
        <h1>Electrical Eng. Calculator</h1>
        <!-- Theme Toggle -->
        <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
            <i class="fas fa-moon"></i>
        </div>
    </header>

    <!-- Calculation Buttons -->
    <div class="calculation-buttons" id="calculationButtons">
        <!-- Buttons will be injected here -->
    </div>

    <!-- Main Calculator Container -->
    <div class="calculator-container">
        <!-- Dynamic Input Fields -->
        <div class="input-group" id="inputGroup">
            <!-- Inputs will be injected here -->
        </div>

        <!-- Result and Formula Display -->
        <div class="result-container">
            <strong>Result:</strong>
            <div class="result" id="result">--</div>
            <strong>Formula:</strong>
            <div class="formula" id="formula">--</div>
        </div>

        <!-- Save to Favorites Button -->
        <button class="save-favorite-btn" onclick="saveFavorite()" title="Save to Favorites">
            <i class="fas fa-star"></i> Save to Favorites
        </button>
    </div>

    <!-- Additional Sections: Favorites and History -->
    <div class="additional-sections">
        <!-- Favorites -->
        <div class="section" id="favorites">
            <strong>Favorites</strong>
            <ul id="favoritesList">
                <!-- Favorite calculations will appear here -->
            </ul>
        </div>

        <!-- History -->
        <div class="section" id="history">
            <strong>
                History
            </strong>
            <ul id="historyList">
                <!-- History items will appear here -->
            </ul>
        </div>
    </div>

    <script>
        // Calculation Definitions
        const calculations = {
            // Fundamental Calculators
            ohms_law: {
                name: "Ohm's Law",
                category: "Fundamental Calculators",
                variables: ["Voltage (V)", "Current (I)", "Resistance (R)"],
                formula: "V = I \\times R",
                calculate: function(inputs, missing) {
                    const V = parseFloat(inputs["Voltage (V)"]);
                    const I = parseFloat(inputs["Current (I)"]);
                    const R = parseFloat(inputs["Resistance (R)"]);

                    if (missing === "Voltage (V)") {
                        if (I === 0) throw new Error("Current cannot be zero.");
                        return I * R;
                    } else if (missing === "Current (I)") {
                        if (R === 0) throw new Error("Resistance cannot be zero.");
                        return V / R;
                    } else if (missing === "Resistance (R)") {
                        if (I === 0) throw new Error("Current cannot be zero.");
                        return V / I;
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Voltage (V)") {
                        return `
                            \\begin{align*}
                            V &= I \\times R \\\\
                            V &= ${formatNumberWithUnit(inputs["Current (I)"], 'I')} \\times ${formatNumberWithUnit(inputs["Resistance (R)"], 'R')} \\\\
                            V &= ${formatNumberWithUnit(result, 'V')}
                            \\end{align*}
                        `;
                    } else if (missing === "Current (I)") {
                        return `
                            \\begin{align*}
                            I &= \\frac{V}{R} \\\\
                            I &= \\frac{${formatNumberWithUnit(inputs["Voltage (V)"], 'V')}}{${formatNumberWithUnit(inputs["Resistance (R)"], 'R')}} \\\\
                            I &= ${formatNumberWithUnit(result, 'I')}
                            \\end{align*}
                        `;
                    } else if (missing === "Resistance (R)") {
                        return `
                            \\begin{align*}
                            R &= \\frac{V}{I} \\\\
                            R &= \\frac{${formatNumberWithUnit(inputs["Voltage (V)"], 'V')}}{${formatNumberWithUnit(inputs["Current (I)"], 'I')}} \\\\
                            R &= ${formatNumberWithUnit(result, 'R')}
                            \\end{align*}
                        `;
                    }
                }
            },
            power: {
                name: "Power",
                category: "Fundamental Calculators",
                variables: ["Voltage (V)", "Current (I)", "Power (P)"],
                formula: "P = V \\times I",
                calculate: function(inputs, missing) {
                    const V = parseFloat(inputs["Voltage (V)"]);
                    const I = parseFloat(inputs["Current (I)"]);
                    const P = parseFloat(inputs["Power (P)"]);

                    if (missing === "Power (P)") {
                        return V * I;
                    } else if (missing === "Voltage (V)") {
                        if (I === 0) throw new Error("Current cannot be zero.");
                        return P / I;
                    } else if (missing === "Current (I)") {
                        if (V === 0) throw new Error("Voltage cannot be zero.");
                        return P / V;
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Power (P)") {
                        return `
                            \\begin{align*}
                            P &= V \\times I \\\\
                            P &= ${formatNumberWithUnit(inputs["Voltage (V)"], 'V')} \\times ${formatNumberWithUnit(inputs["Current (I)"], 'I')} \\\\
                            P &= ${formatNumberWithUnit(result, 'P')}
                            \\end{align*}
                        `;
                    } else if (missing === "Voltage (V)") {
                        return `
                            \\begin{align*}
                            V &= \\frac{P}{I} \\\\
                            V &= \\frac{${formatNumberWithUnit(inputs["Power (P)"], 'P')}}{${formatNumberWithUnit(inputs["Current (I)"], 'I')}} \\\\
                            V &= ${formatNumberWithUnit(result, 'V')}
                            \\end{align*}
                        `;
                    } else if (missing === "Current (I)") {
                        return `
                            \\begin{align*}
                            I &= \\frac{P}{V} \\\\
                            I &= \\frac{${formatNumberWithUnit(inputs["Power (P)"], 'P')}}{${formatNumberWithUnit(inputs["Voltage (V)"], 'V')}} \\\\
                            I &= ${formatNumberWithUnit(result, 'I')}
                            \\end{align*}
                        `;
                    }
                }
            },
            energy: {
                name: "Energy",
                category: "Fundamental Calculators",
                variables: ["Power (P)", "Time (t)", "Energy (E)"],
                formula: "E = P \\times t",
                calculate: function(inputs, missing) {
                    const P = parseFloat(inputs["Power (P)"]);
                    const t = parseFloat(inputs["Time (t)"]);
                    const E = parseFloat(inputs["Energy (E)"]);

                    if (missing === "Energy (E)") {
                        return P * t;
                    } else if (missing === "Power (P)") {
                        if (t === 0) throw new Error("Time cannot be zero.");
                        return E / t;
                    } else if (missing === "Time (t)") {
                        if (P === 0) throw new Error("Power cannot be zero.");
                        return E / P;
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Energy (E)") {
                        return `
                            \\begin{align*}
                            E &= P \\times t \\\\
                            E &= ${formatNumberWithUnit(inputs["Power (P)"], 'P')} \\times ${formatNumberWithUnit(inputs["Time (t)"], 't')} \\\\
                            E &= ${formatNumberWithUnit(result, 'E')}
                            \\end{align*}
                        `;
                    } else if (missing === "Power (P)") {
                        return `
                            \\begin{align*}
                            P &= \\frac{E}{t} \\\\
                            P &= \\frac{${formatNumberWithUnit(inputs["Energy (E)"], 'E')}}{${formatNumberWithUnit(inputs["Time (t)"], 't')}} \\\\
                            P &= ${formatNumberWithUnit(result, 'P')}
                            \\end{align*}
                        `;
                    } else if (missing === "Time (t)") {
                        return `
                            \\begin{align*}
                            t &= \\frac{E}{P} \\\\
                            t &= \\frac{${formatNumberWithUnit(inputs["Energy (E)"], 'E')}}{${formatNumberWithUnit(inputs["Power (P)"], 'P')}} \\\\
                            t &= ${formatNumberWithUnit(result, 't')}
                            \\end{align*}
                        `;
                    }
                }
            },
            // Circuit Analysis
            resistance_series: {
                name: "Series Resistance",
                category: "Circuit Analysis",
                variables: ["Total Resistance (R_total)"],
                formula: "R_{total} = R_1 + R_2 + ... + R_n",
                calculate: function(inputs, missing) {
                    // Collect all resistor values dynamically
                    const resistorKeys = Object.keys(inputs).filter(key => key.startsWith('Resistance_'));
                    const resistors = resistorKeys.map(key => parseFloat(inputs[key]));

                    if (missing === "Total Resistance (R_total)") {
                        const total = resistors.reduce((acc, curr) => acc + curr, 0);
                        return total;
                    } else {
                        // Calculating individual resistor based on total resistance
                        const R_total = parseFloat(inputs["Total Resistance (R_total)"]);
                        const otherResistors = resistors.filter((_, index) => resistorKeys[index] !== missing);
                        const sumOther = otherResistors.reduce((acc, curr) => acc + curr, 0);
                        const calculatedResistor = R_total - sumOther;
                        if (calculatedResistor < 0) throw new Error(`${missing} cannot be negative.`);
                        return calculatedResistor;
                    }
                },
                explanation: function(inputs, result, missing) {
                    // Collect all resistor values dynamically
                    const resistorKeys = Object.keys(inputs).filter(key => key.startsWith('Resistance_'));
                    const resistors = resistorKeys.map(key => parseFloat(inputs[key]));
                    const resistorNames = resistorKeys.map(key => key.replace('Resistance_', 'R'));

                    if (missing === "Total Resistance (R_total)") {
                        const sum = resistors.join(' + ');
                        const total = resistors.reduce((acc, curr) => acc + curr, 0);
                        return `
                            \\begin{align*}
                            R_{total} &= ${resistors.map(r => `${formatNumberWithUnit(r, '')}`).join(' + ')} \\\\
                            R_{total} &= ${formatNumberWithUnit(total, 'R_total')}
                            \\end{align*}
                        `;
                    } else {
                        // Find which resistor is missing
                        const missingIndex = resistorKeys.indexOf(missing);
                        const resistorNumber = missingIndex + 1; // R1, R2, etc.
                        const otherResistors = resistorNames.filter((_, index) => resistorKeys[index] !== missingIndex);
                        const sumOther = resistors.reduce((acc, curr) => acc + curr, 0);
                        return `
                            \\begin{align*}
                            R_{total} &= R_${resistorNumber} + ${otherResistors.join(' + ')} \\\\
                            R_${resistorNumber} &= R_{total} - ${formatNumberWithUnit(sumOther, '')} \\\\
                            R_${resistorNumber} &= ${formatNumberWithUnit(inputs["Total Resistance (R_total)"], 'R_total')} - ${formatNumberWithUnit(sumOther, '')} \\\\
                            R_${resistorNumber} &= ${formatNumberWithUnit(result, missing)}
                            \\end{align*}
                        `;
                    }
                }
            },
            resistance_parallel: {
                name: "Parallel Resistance",
                category: "Circuit Analysis",
                variables: ["Total Resistance (R_total)"],
                formula: "\\(\\frac{1}{R_{total}} = \\frac{1}{R_1} + \\frac{1}{R_2} + ... + \\frac{1}{R_n}\\)",
                calculate: function(inputs, missing) {
                    // Collect all resistor values dynamically
                    const resistorKeys = Object.keys(inputs).filter(key => key.startsWith('Resistance_'));
                    const resistors = resistorKeys.map(key => parseFloat(inputs[key]));

                    if (missing === "Total Resistance (R_total)") {
                        const reciprocalSum = resistors.reduce((acc, curr) => acc + (1 / curr), 0);
                        if (reciprocalSum === 0) throw new Error("Reciprocal sum cannot be zero.");
                        return 1 / reciprocalSum;
                    } else {
                        // Calculating individual resistor based on total resistance
                        const R_total = parseFloat(inputs["Total Resistance (R_total)"]);
                        const sumOtherReciprocals = resistors.reduce((acc, curr) => acc + (1 / curr), 0);
                        const calculatedReciprocal = (1 / R_total) - sumOtherReciprocals;
                        if (calculatedReciprocal <= 0) throw new Error(`${missing} must be positive.`);
                        const calculatedResistor = 1 / calculatedReciprocal;
                        return calculatedResistor;
                    }
                },
                explanation: function(inputs, result, missing) {
                    // Collect all resistor values dynamically
                    const resistorKeys = Object.keys(inputs).filter(key => key.startsWith('Resistance_'));
                    const resistors = resistorKeys.map(key => parseFloat(inputs[key]));
                    const resistorNames = resistorKeys.map(key => key.replace('Resistance_', 'R'));

                    if (missing === "Total Resistance (R_total)") {
                        const terms = resistors.map(r => `\\frac{1}{${formatNumberWithUnit(r, '')}}`).join(' + ');
                        const reciprocalSum = resistors.reduce((acc, curr) => acc + (1 / curr), 0);
                        return `
                            \\begin{align*}
                            \\frac{1}{R_{total}} &= ${terms} \\\\
                            \\frac{1}{R_{total}} &= ${formatNumberWithUnit(reciprocalSum, '')} \\\\
                            R_{total} &= \\frac{1}{${formatNumberWithUnit(reciprocalSum, '')}} \\\\
                            R_{total} &= ${formatNumberWithUnit(result, 'R_total')}
                            \\end{align*}
                        `;
                    } else {
                        // Find which resistor is missing
                        const missingIndex = resistorKeys.indexOf(missing);
                        const resistorNumber = missingIndex + 1; // R1, R2, etc.
                        const otherResistors = resistors.filter((_, index) => resistorKeys[index] !== missingIndex);
                        const reciprocalSumOther = otherResistors.reduce((acc, curr) => acc + (1 / curr), 0);
                        const calculatedReciprocal = (1 / parseFloat(inputs["Total Resistance (R_total)"])) - reciprocalSumOther;
                        const calculatedResistor = 1 / calculatedReciprocal;
                        return `
                            \\begin{align*}
                            \\frac{1}{R_{total}} &= \\frac{1}{R_${resistorNumber}} + ${otherResistors.map(r => `\\frac{1}{R}`).join(' + ')} \\\\
                            \\frac{1}{R_${resistorNumber}} &= \\frac{1}{R_{total}} - ${otherResistors.map(r => `\\frac{1}{R}`).join(' + ')} \\\\
                            R_${resistorNumber} &= \\frac{1}{${formatNumberWithUnit(calculatedReciprocal, '')}} \\\\
                            R_${resistorNumber} &= ${formatNumberWithUnit(result, missing)}
                            \\end{align*}
                        `;
                    }
                }
            },
            voltage_divider: {
                name: "Voltage Divider",
                category: "Circuit Analysis",
                variables: ["Input Voltage (V_in)", "Resistor 1 (R1)", "Resistor 2 (R2)", "Output Voltage (V_out)"],
                formula: "V_{out} = V_{in} \\times \\frac{R2}{R1 + R2}",
                calculate: function(inputs, missing) {
                    const V_in = parseFloat(inputs["Input Voltage (V_in)"]);
                    const R1 = parseFloat(inputs["Resistor 1 (R1)"]);
                    const R2 = parseFloat(inputs["Resistor 2 (R2)"]);
                    const V_out = parseFloat(inputs["Output Voltage (V_out)"]);

                    if (missing === "Output Voltage (V_out)") {
                        return V_in * (R2 / (R1 + R2));
                    } else if (missing === "Input Voltage (V_in)") {
                        if (R2 === 0 || (R1 + R2) === 0) throw new Error("Resistor values cannot be zero.");
                        return V_out / (R2 / (R1 + R2));
                    } else if (missing === "Resistor 1 (R1)") {
                        if (V_out === 0) throw new Error("Output Voltage cannot be zero.");
                        return (V_in * R2 / V_out) - R2;
                    } else if (missing === "Resistor 2 (R2)") {
                        if (V_in === 0) throw new Error("Input Voltage cannot be zero.");
                        return (V_out * (R1 + R2)) / V_in;
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Output Voltage (V_out)") {
                        return `
                            \\begin{align*}
                            V_{out} &= V_{in} \\times \\frac{R2}{R1 + R2} \\\\
                            V_{out} &= ${formatNumberWithUnit(inputs["Input Voltage (V_in)"], 'V_in')} \\times \\frac{${formatNumberWithUnit(inputs["Resistor 2 (R2)"], 'R2')}}{${formatNumberWithUnit(inputs["Resistor 1 (R1)"], 'R1')} + ${formatNumberWithUnit(inputs["Resistor 2 (R2)"], 'R2')}} \\\\
                            V_{out} &= ${formatNumberWithUnit(result, 'V_out')}
                            \\end{align*}
                        `;
                    } else if (missing === "Input Voltage (V_in)") {
                        return `
                            \\begin{align*}
                            V_{in} &= \\frac{V_{out}}{\\frac{R2}{R1 + R2}} \\\\
                            V_{in} &= V_{out} \\times \\frac{R1 + R2}{R2} \\\\
                            V_{in} &= ${formatNumberWithUnit(result, 'V_in')}
                            \\end{align*}
                        `;
                    } else if (missing === "Resistor 1 (R1)") {
                        return `
                            \\begin{align*}
                            R1 &= \\frac{V_{in} \\times R2}{V_{out}} - R2 \\\\
                            R1 &= \\frac{${formatNumberWithUnit(inputs["Input Voltage (V_in)"], 'V_in')} \\times ${formatNumberWithUnit(inputs["Resistor 2 (R2)"], 'R2')}}{${formatNumberWithUnit(inputs["Output Voltage (V_out)"], 'V_out')}} - ${formatNumberWithUnit(inputs["Resistor 2 (R2)"], 'R2')} \\\\
                            R1 &= ${formatNumberWithUnit(result, 'R1')}
                            \\end{align*}
                        `;
                    } else if (missing === "Resistor 2 (R2)") {
                        return `
                            \\begin{align*}
                            R2 &= \\frac{V_{out} \\times (R1 + R2)}{V_{in}} \\\\
                            R2 &= \\frac{${formatNumberWithUnit(inputs["Output Voltage (V_out)"], 'V_out')} \\times (${formatNumberWithUnit(inputs["Resistor 1 (R1)"], 'R1')} + R2)}{${formatNumberWithUnit(inputs["Input Voltage (V_in)"], 'V_in')}} \\\\
                            R2 &= ${formatNumberWithUnit(result, 'R2')}
                            \\end{align*}
                        `;
                    }
                }
            },
            current_divider: {
                name: "Current Divider",
                category: "Circuit Analysis",
                variables: ["Input Current (I_in)", "Resistor 1 (R1)", "Resistor 2 (R2)", "Output Current (I_out)"],
                formula: "I_{out} = I_{in} \\times \\frac{R1}{R1 + R2}",
                calculate: function(inputs, missing) {
                    const I_in = parseFloat(inputs["Input Current (I_in)"]);
                    const R1 = parseFloat(inputs["Resistor 1 (R1)"]);
                    const R2 = parseFloat(inputs["Resistor 2 (R2)"]);
                    const I_out = parseFloat(inputs["Output Current (I_out)"]);

                    if (missing === "Output Current (I_out)") {
                        return I_in * (R1 / (R1 + R2));
                    } else if (missing === "Input Current (I_in)") {
                        if (R1 + R2 === 0) throw new Error("Sum of resistors cannot be zero.");
                        return I_out / (R1 / (R1 + R2));
                    } else if (missing === "Resistor 1 (R1)") {
                        if (I_out === 0) throw new Error("Output Current cannot be zero.");
                        return (I_in * R1 / I_out) - R1;
                    } else if (missing === "Resistor 2 (R2)") {
                        if (I_in === 0) throw new Error("Input Current cannot be zero.");
                        return (I_out * (R1 + R2)) / I_in;
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Output Current (I_out)") {
                        return `
                            \\begin{align*}
                            I_{out} &= I_{in} \\times \\frac{R1}{R1 + R2} \\\\
                            I_{out} &= ${formatNumberWithUnit(inputs["Input Current (I_in)"], 'I_in')} \\times \\frac{${formatNumberWithUnit(inputs["Resistor 1 (R1)"], 'R1')}}{${formatNumberWithUnit(inputs["Resistor 1 (R1)"], 'R1')} + ${formatNumberWithUnit(inputs["Resistor 2 (R2)"], 'R2')}} \\\\
                            I_{out} &= ${formatNumberWithUnit(result, 'I_out')}
                            \\end{align*}
                        `;
                    } else if (missing === "Input Current (I_in)") {
                        return `
                            \\begin{align*}
                            I_{in} &= \\frac{I_{out}}{\\frac{R1}{R1 + R2}} \\\\
                            I_{in} &= I_{out} \\times \\frac{R1 + R2}{R1} \\\\
                            I_{in} &= ${formatNumberWithUnit(result, 'I_in')}
                            \\end{align*}
                        `;
                    } else if (missing === "Resistor 1 (R1)") {
                        return `
                            \\begin{align*}
                            R1 &= \\frac{I_{in} \\times R2}{I_{out}} - R2 \\\\
                            R1 &= \\frac{${formatNumberWithUnit(inputs["Input Current (I_in)"], 'I_in')} \\times ${formatNumberWithUnit(inputs["Resistor 2 (R2)"], 'R2')}}{${formatNumberWithUnit(inputs["Output Current (I_out)"], 'I_out')}} - ${formatNumberWithUnit(inputs["Resistor 2 (R2)"], 'R2')} \\\\
                            R1 &= ${formatNumberWithUnit(result, 'R1')}
                            \\end{align*}
                        `;
                    } else if (missing === "Resistor 2 (R2)") {
                        return `
                            \\begin{align*}
                            R2 &= \\frac{I_{in} \\times R1}{I_{out}} - R1 \\\\
                            R2 &= \\frac{${formatNumberWithUnit(inputs["Input Current (I_in)"], 'I_in')} \\times ${formatNumberWithUnit(inputs["Resistor 1 (R1)"], 'R1')}}{${formatNumberWithUnit(inputs["Output Current (I_out)"], 'I_out')}} - ${formatNumberWithUnit(inputs["Resistor 1 (R1)"], 'R1')} \\\\
                            R2 &= ${formatNumberWithUnit(result, 'R2')}
                            \\end{align*}
                        `;
                    }
                }
            },
            // AC Circuit Calculators
            capacitive_reactance: {
                name: "Capacitive Reactance",
                category: "AC Circuit Calculators",
                variables: ["Frequency (f)", "Capacitance (C)", "Reactance (X_C)"],
                formula: "X_C = \\frac{1}{2 \\pi f C}",
                calculate: function(inputs, missing) {
                    const f = parseFloat(inputs["Frequency (f)"]);
                    const C = parseFloat(inputs["Capacitance (C)"]);
                    const X_C = parseFloat(inputs["Reactance (X_C)"]);

                    if (missing === "Reactance (X_C)") {
                        if (f === 0 || C === 0) throw new Error("Frequency and Capacitance cannot be zero.");
                        return 1 / (2 * Math.PI * f * C);
                    } else if (missing === "Frequency (f)") {
                        if (X_C === 0 || C === 0) throw new Error("Reactance and Capacitance cannot be zero.");
                        return 1 / (2 * Math.PI * X_C * C);
                    } else if (missing === "Capacitance (C)") {
                        if (X_C === 0 || f === 0) throw new Error("Reactance and Frequency cannot be zero.");
                        return 1 / (2 * Math.PI * f * X_C);
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Reactance (X_C)") {
                        return `
                            \\begin{align*}
                            X_C &= \\frac{1}{2 \\pi f C} \\\\
                            X_C &= \\frac{1}{2 \\times \\pi \\times ${formatNumberWithUnit(inputs["Frequency (f)"], 'f')} \\times ${formatNumberWithUnit(inputs["Capacitance (C)"], 'C')}} \\\\
                            X_C &= ${formatNumberWithUnit(result, 'X_C')}
                            \\end{align*}
                        `;
                    } else if (missing === "Frequency (f)") {
                        return `
                            \\begin{align*}
                            f &= \\frac{1}{2 \\pi X_C C} \\\\
                            f &= \\frac{1}{2 \\times \\pi \\times ${formatNumberWithUnit(inputs["Reactance (X_C)"], 'X_C')} \\times ${formatNumberWithUnit(inputs["Capacitance (C)"], 'C')}} \\\\
                            f &= ${formatNumberWithUnit(result, 'f')}
                            \\end{align*}
                        `;
                    } else if (missing === "Capacitance (C)") {
                        return `
                            \\begin{align*}
                            C &= \\frac{1}{2 \\pi f X_C} \\\\
                            C &= \\frac{1}{2 \\times \\pi \\times ${formatNumberWithUnit(inputs["Frequency (f)"], 'f')} \\times ${formatNumberWithUnit(inputs["Reactance (X_C)"], 'X_C')}} \\\\
                            C &= ${formatNumberWithUnit(result, 'C')}
                            \\end{align*}
                        `;
                    }
                }
            },
            inductive_reactance: {
                name: "Inductive Reactance",
                category: "AC Circuit Calculators",
                variables: ["Frequency (f)", "Inductance (L)", "Reactance (X_L)"],
                formula: "X_L = 2 \\pi f L",
                calculate: function(inputs, missing) {
                    const f = parseFloat(inputs["Frequency (f)"]);
                    const L = parseFloat(inputs["Inductance (L)"]);
                    const X_L = parseFloat(inputs["Reactance (X_L)"]);

                    if (missing === "Reactance (X_L)") {
                        return 2 * Math.PI * f * L;
                    } else if (missing === "Frequency (f)") {
                        if (X_L === 0 || L === 0) throw new Error("Reactance and Inductance cannot be zero.");
                        return X_L / (2 * Math.PI * L);
                    } else if (missing === "Inductance (L)") {
                        if (X_L === 0 || f === 0) throw new Error("Reactance and Frequency cannot be zero.");
                        return X_L / (2 * Math.PI * f);
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Reactance (X_L)") {
                        return `
                            \\begin{align*}
                            X_L &= 2 \\pi f L \\\\
                            X_L &= 2 \\times \\pi \\times ${formatNumberWithUnit(inputs["Frequency (f)"], 'f')} \\times ${formatNumberWithUnit(inputs["Inductance (L)"], 'L')} \\\\
                            X_L &= ${formatNumberWithUnit(result, 'X_L')}
                            \\end{align*}
                        `;
                    } else if (missing === "Frequency (f)") {
                        return `
                            \\begin{align*}
                            f &= \\frac{X_L}{2 \\pi L} \\\\
                            f &= \\frac{${formatNumberWithUnit(inputs["Reactance (X_L)"], 'X_L')}}{2 \\times \\pi \\times ${formatNumberWithUnit(inputs["Inductance (L)"], 'L')}} \\\\
                            f &= ${formatNumberWithUnit(result, 'f')}
                            \\end{align*}
                        `;
                    } else if (missing === "Inductance (L)") {
                        return `
                            \\begin{align*}
                            L &= \\frac{X_L}{2 \\pi f} \\\\
                            L &= \\frac{${formatNumberWithUnit(inputs["Reactance (X_L)"], 'X_L')}}{2 \\times \\pi \\times ${formatNumberWithUnit(inputs["Frequency (f)"], 'f')}} \\\\
                            L &= ${formatNumberWithUnit(result, 'L')}
                            \\end{align*}
                        `;
                    }
                }
            },
            impedance: {
                name: "Impedance",
                category: "AC Circuit Calculators",
                variables: ["Resistance (R)", "Inductive Reactance (X_L)", "Capacitive Reactance (X_C)", "Impedance (Z)"],
                formula: "Z = \\sqrt{R^2 + (X_L - X_C)^2}",
                calculate: function(inputs, missing) {
                    const R = parseFloat(inputs["Resistance (R)"]);
                    const X_L = parseFloat(inputs["Inductive Reactance (X_L)"]);
                    const X_C = parseFloat(inputs["Capacitive Reactance (X_C)"]);
                    const Z = parseFloat(inputs["Impedance (Z)"]);

                    if (missing === "Impedance (Z)") {
                        return Math.sqrt(Math.pow(R, 2) + Math.pow(X_L - X_C, 2));
                    } else if (missing === "Resistance (R)") {
                        if (Z === 0 || (X_L - X_C) === 0) throw new Error("Impedance and (X_L - X_C) cannot be zero.");
                        return Math.sqrt(Math.pow(Z, 2) - Math.pow(X_L - X_C, 2));
                    } else if (missing === "Inductive Reactance (X_L)") {
                        if (Z === 0 || R === 0) throw new Error("Impedance and Resistance cannot be zero.");
                        return Math.sqrt(Math.pow(Z, 2) - Math.pow(R, 2)) + X_C;
                    } else if (missing === "Capacitive Reactance (X_C)") {
                        if (Z === 0 || R === 0) throw new Error("Impedance and Resistance cannot be zero.");
                        return X_L - Math.sqrt(Math.pow(Z, 2) - Math.pow(R, 2));
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Impedance (Z)") {
                        return `
                            \\begin{align*}
                            Z &= \\sqrt{R^2 + (X_L - X_C)^2} \\\\
                            Z &= \\sqrt{${formatNumberWithUnit(inputs["Resistance (R)"], 'R')}^2 + (${formatNumberWithUnit(inputs["Inductive Reactance (X_L)"], 'X_L')} - ${formatNumberWithUnit(inputs["Capacitive Reactance (X_C)"], 'X_C')})^2} \\\\
                            Z &= ${formatNumberWithUnit(result, 'Z')}
                            \\end{align*}
                        `;
                    } else if (missing === "Resistance (R)") {
                        return `
                            \\begin{align*}
                            R &= \\sqrt{Z^2 - (X_L - X_C)^2} \\\\
                            R &= \\sqrt{${formatNumberWithUnit(inputs["Impedance (Z)"], 'Z')}^2 - (${formatNumberWithUnit(inputs["Inductive Reactance (X_L)"], 'X_L')} - ${formatNumberWithUnit(inputs["Capacitive Reactance (X_C)"], 'X_C')})^2} \\\\
                            R &= ${formatNumberWithUnit(result, 'R')}
                            \\end{align*}
                        `;
                    } else if (missing === "Inductive Reactance (X_L)") {
                        return `
                            \\begin{align*}
                            X_L &= \\sqrt{Z^2 - R^2} + X_C \\\\
                            X_L &= \\sqrt{${formatNumberWithUnit(inputs["Impedance (Z)"], 'Z')}^2 - ${formatNumberWithUnit(inputs["Resistance (R)"], 'R')}^2} + ${formatNumberWithUnit(inputs["Capacitive Reactance (X_C)"], 'X_C')} \\\\
                            X_L &= ${formatNumberWithUnit(result, 'X_L')}
                            \\end{align*}
                        `;
                    } else if (missing === "Capacitive Reactance (X_C)") {
                        return `
                            \\begin{align*}
                            X_C &= X_L - \\sqrt{Z^2 - R^2} \\\\
                            X_C &= ${formatNumberWithUnit(inputs["Inductive Reactance (X_L)"], 'X_L')} - \\sqrt{${formatNumberWithUnit(inputs["Impedance (Z)"], 'Z')}^2 - ${formatNumberWithUnit(inputs["Resistance (R)"], 'R')}^2} \\\\
                            X_C &= ${formatNumberWithUnit(result, 'X_C')}
                            \\end{align*}
                        `;
                    }
                }
            },
            phase_angle: {
                name: "Phase Angle",
                category: "AC Circuit Calculators",
                variables: ["Resistance (R)", "Reactance (X)", "Phase Angle (θ)"],
                formula: "\\theta = \\arctan\\left(\\frac{X}{R}\\right)",
                calculate: function(inputs, missing) {
                    const R = parseFloat(inputs["Resistance (R)"]);
                    const X = parseFloat(inputs["Reactance (X)"]);
                    const theta = parseFloat(inputs["Phase Angle (θ)"]);
                    if (missing === "Phase Angle (θ)") {
                        return Math.atan(X / R) * (180 / Math.PI); // Convert to degrees
                    } else if (missing === "Resistance (R)") {
                        return X / Math.tan(theta * (Math.PI / 180));
                    } else if (missing === "Reactance (X)") {
                        return R * Math.tan(theta * (Math.PI / 180));
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Phase Angle (θ)") {
                        return `
                            \\begin{align*}
                            \\theta &= \\arctan\\left(\\frac{X}{R}\\right) \\\\
                            \\theta &= \\arctan\\left(\\frac{${formatNumberWithUnit(inputs["Reactance (X)"], 'X')}}{${formatNumberWithUnit(inputs["Resistance (R)"], 'R')}}\\right) \\\\
                            \\theta &= ${formatNumberWithUnit(result, 'θ')}^\\circ
                            \\end{align*}
                        `;
                    } else if (missing === "Resistance (R)") {
                        return `
                            \\begin{align*}
                            R &= \\frac{X}{\\tan\\theta} \\\\
                            R &= \\frac{${formatNumberWithUnit(inputs["Reactance (X)"], 'X')}}{\\tan${formatNumberWithUnit(inputs["Phase Angle (θ)"], 'θ')}^\\circ} \\\\
                            R &= ${formatNumberWithUnit(result, 'R')}
                            \\end{align*}
                        `;
                    } else if (missing === "Reactance (X)") {
                        return `
                            \\begin{align*}
                            X &= R \\times \\tan\\theta \\\\
                            X &= ${formatNumberWithUnit(inputs["Resistance (R)"], 'R')} \\times \\tan${formatNumberWithUnit(inputs["Phase Angle (θ)"], 'θ')}^\\circ \\\\
                            X &= ${formatNumberWithUnit(result, 'X')}
                            \\end{align*}
                        `;
                    }
                }
            },
            power_factor: {
                name: "Power Factor",
                category: "AC Circuit Calculators",
                variables: ["Apparent Power (S)", "Real Power (P)", "Power Factor (pf)"],
                formula: "pf = \\frac{P}{S}",
                calculate: function(inputs, missing) {
                    const S = parseFloat(inputs["Apparent Power (S)"]);
                    const P = parseFloat(inputs["Real Power (P)"]);
                    const pf = parseFloat(inputs["Power Factor (pf)"]);
                    if (missing === "Power Factor (pf)") {
                        if (S === 0) throw new Error("Apparent Power cannot be zero.");
                        return P / S;
                    } else if (missing === "Apparent Power (S)") {
                        if (pf === 0) throw new Error("Power Factor cannot be zero.");
                        return P / pf;
                    } else if (missing === "Real Power (P)") {
                        return S * pf;
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Power Factor (pf)") {
                        return `
                            \\begin{align*}
                            pf &= \\frac{P}{S} \\\\
                            pf &= \\frac{${formatNumberWithUnit(inputs["Real Power (P)"], 'P')}}{${formatNumberWithUnit(inputs["Apparent Power (S)"], 'S')}} \\\\
                            pf &= ${formatNumberWithUnit(result, 'pf')}
                            \\end{align*}
                        `;
                    } else if (missing === "Apparent Power (S)") {
                        return `
                            \\begin{align*}
                            S &= \\frac{P}{pf} \\\\
                            S &= \\frac{${formatNumberWithUnit(inputs["Real Power (P)"], 'P')}}{${formatNumberWithUnit(inputs["Power Factor (pf)"], 'pf')}} \\\\
                            S &= ${formatNumberWithUnit(result, 'S')}
                            \\end{align*}
                        `;
                    } else if (missing === "Real Power (P)") {
                        return `
                            \\begin{align*}
                            P &= S \\times pf \\\\
                            P &= ${formatNumberWithUnit(inputs["Apparent Power (S)"], 'S')} \\times ${formatNumberWithUnit(inputs["Power Factor (pf)"], 'pf')} \\\\
                            P &= ${formatNumberWithUnit(result, 'P')}
                            \\end{align*}
                        `;
                    }
                }
            },
            // Advanced Components and Systems
            transformer: {
                name: "Transformer",
                category: "Advanced Components and Systems",
                variables: ["Primary Voltage (V_p)", "Secondary Voltage (V_s)", "Primary Turns (N_p)", "Secondary Turns (N_s)"],
                formula: "\\frac{V_p}{V_s} = \\frac{N_p}{N_s}",
                calculate: function(inputs, missing) {
                    const V_p = parseFloat(inputs["Primary Voltage (V_p)"]);
                    const V_s = parseFloat(inputs["Secondary Voltage (V_s)"]);
                    const N_p = parseFloat(inputs["Primary Turns (N_p)"]);
                    const N_s = parseFloat(inputs["Secondary Turns (N_s)"]);

                    if (missing === "Primary Voltage (V_p)") {
                        return (V_s * N_p) / N_s;
                    } else if (missing === "Secondary Voltage (V_s)") {
                        return (V_p * N_s) / N_p;
                    } else if (missing === "Primary Turns (N_p)") {
                        return (V_p * N_s) / V_s;
                    } else if (missing === "Secondary Turns (N_s)") {
                        return (V_s * N_p) / V_p;
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Primary Voltage (V_p)") {
                        return `
                            \\begin{align*}
                            V_p &= V_s \\times \\frac{N_p}{N_s} \\\\
                            V_p &= ${formatNumberWithUnit(inputs["Secondary Voltage (V_s)"], 'V_s')} \\times \\frac{${formatNumberWithUnit(inputs["Primary Turns (N_p)"], 'N_p')}}{${formatNumberWithUnit(inputs["Secondary Turns (N_s)"], 'N_s')}} \\\\
                            V_p &= ${formatNumberWithUnit(result, 'V_p')}
                            \\end{align*}
                        `;
                    } else if (missing === "Secondary Voltage (V_s)") {
                        return `
                            \\begin{align*}
                            V_s &= V_p \\times \\frac{N_s}{N_p} \\\\
                            V_s &= ${formatNumberWithUnit(inputs["Primary Voltage (V_p)"], 'V_p')} \\times \\frac{${formatNumberWithUnit(inputs["Secondary Turns (N_s)"], 'N_s')}}{${formatNumberWithUnit(inputs["Primary Turns (N_p)"], 'N_p')}} \\\\
                            V_s &= ${formatNumberWithUnit(result, 'V_s')}
                            \\end{align*}
                        `;
                    } else if (missing === "Primary Turns (N_p)") {
                        return `
                            \\begin{align*}
                            N_p &= \\frac{V_p \\times N_s}{V_s} \\\\
                            N_p &= \\frac{${formatNumberWithUnit(inputs["Primary Voltage (V_p)"], 'V_p')} \\times ${formatNumberWithUnit(inputs["Secondary Turns (N_s)"], 'N_s')}}{${formatNumberWithUnit(inputs["Secondary Voltage (V_s)"], 'V_s')}} \\\\
                            N_p &= ${formatNumberWithUnit(result, 'N_p')}
                            \\end{align*}
                        `;
                    } else if (missing === "Secondary Turns (N_s)") {
                        return `
                            \\begin{align*}
                            N_s &= \\frac{V_s \\times N_p}{V_p} \\\\
                            N_s &= \\frac{${formatNumberWithUnit(inputs["Secondary Voltage (V_s)"], 'V_s')} \\times ${formatNumberWithUnit(inputs["Primary Turns (N_p)"], 'N_p')}}{${formatNumberWithUnit(inputs["Primary Voltage (V_p)"], 'V_p')}} \\\\
                            N_s &= ${formatNumberWithUnit(result, 'N_s')}
                            \\end{align*}
                        `;
                    }
                }
            },
            op_amp: {
                name: "Op-Amp Configuration",
                category: "Advanced Components and Systems",
                variables: ["Input Voltage (V_in)", "Feedback Resistor (R_f)", "Input Resistor (R_in)", "Output Voltage (V_out)"],
                formula: "V_{out} = - \\left(\\frac{R_f}{R_{in}}\\right) V_{in}",
                calculate: function(inputs, missing) {
                    const V_in = parseFloat(inputs["Input Voltage (V_in)"]);
                    const R_f = parseFloat(inputs["Feedback Resistor (R_f)"]);
                    const R_in = parseFloat(inputs["Input Resistor (R_in)"]);
                    const V_out = parseFloat(inputs["Output Voltage (V_out)"]);

                    if (missing === "Output Voltage (V_out)") {
                        return - (R_f / R_in) * V_in;
                    } else if (missing === "Input Voltage (V_in)") {
                        if (R_in === 0) throw new Error("Input Resistor cannot be zero.");
                        return - (V_out * R_in) / R_f;
                    } else if (missing === "Feedback Resistor (R_f)") {
                        if (V_in === 0) throw new Error("Input Voltage cannot be zero.");
                        return - (V_out * R_in) / V_in;
                    } else if (missing === "Input Resistor (R_in)") {
                        if (V_in === 0) throw new Error("Input Voltage cannot be zero.");
                        return - (R_f * V_in) / V_out;
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Output Voltage (V_out)") {
                        return `
                            \\begin{align*}
                            V_{out} &= - \\left(\\frac{R_f}{R_{in}}\\right) V_{in} \\\\
                            V_{out} &= - \\left(\\frac{${formatNumberWithUnit(inputs["Feedback Resistor (R_f)"], 'R_f')}}{${formatNumberWithUnit(inputs["Input Resistor (R_in)"], 'R_in')}}\\right) \\times ${formatNumberWithUnit(inputs["Input Voltage (V_in)"], 'V_in')} \\\\
                            V_{out} &= ${formatNumberWithUnit(result, 'V_out')}
                            \\end{align*}
                        `;
                    } else if (missing === "Input Voltage (V_in)") {
                        return `
                            \\begin{align*}
                            V_{in} &= - \\frac{V_{out} \\times R_{in}}{R_f} \\\\
                            V_{in} &= - \\frac{${formatNumberWithUnit(inputs["Output Voltage (V_out)"], 'V_out')} \\times ${formatNumberWithUnit(inputs["Input Resistor (R_in)"], 'R_in')}}{${formatNumberWithUnit(inputs["Feedback Resistor (R_f)"], 'R_f')}} \\\\
                            V_{in} &= ${formatNumberWithUnit(result, 'V_in')}
                            \\end{align*}
                        `;
                    } else if (missing === "Feedback Resistor (R_f)") {
                        return `
                            \\begin{align*}
                            R_f &= - \\frac{V_{out} \\times R_{in}}{V_{in}} \\\\
                            R_f &= - \\frac{${formatNumberWithUnit(inputs["Output Voltage (V_out)"], 'V_out')} \\times ${formatNumberWithUnit(inputs["Input Resistor (R_in)"], 'R_in')}}{${formatNumberWithUnit(inputs["Input Voltage (V_in)"], 'V_in')}} \\\\
                            R_f &= ${formatNumberWithUnit(result, 'R_f')}
                            \\end{align*}
                        `;
                    } else if (missing === "Input Resistor (R_in)") {
                        return `
                            \\begin{align*}
                            R_{in} &= - \\frac{R_f \\times V_{in}}{V_{out}} \\\\
                            R_{in} &= - \\frac{${formatNumberWithUnit(inputs["Feedback Resistor (R_f)"], 'R_f')} \\times ${formatNumberWithUnit(inputs["Input Voltage (V_in)"], 'V_in')}}{${formatNumberWithUnit(inputs["Output Voltage (V_out)"], 'V_out')}} \\\\
                            R_{in} &= ${formatNumberWithUnit(result, 'R_in')}
                            \\end{align*}
                        `;
                    }
                }
            },
            // Resonance and Filter Design
            resonant_frequency: {
                name: "Resonant Frequency",
                category: "Resonance and Filter Design",
                variables: ["Inductance (L)", "Capacitance (C)", "Frequency (f)"],
                formula: "f = \\frac{1}{2 \\pi \\sqrt{L C}}",
                calculate: function(inputs, missing) {
                    const L = parseFloat(inputs["Inductance (L)"]);
                    const C = parseFloat(inputs["Capacitance (C)"]);
                    const f = parseFloat(inputs["Frequency (f)"]);

                    if (missing === "Frequency (f)") {
                        return 1 / (2 * Math.PI * Math.sqrt(L * C));
                    } else if (missing === "Inductance (L)") {
                        return 1 / (Math.pow(2 * Math.PI * f, 2) * C);
                    } else if (missing === "Capacitance (C)") {
                        return 1 / (Math.pow(2 * Math.PI * f, 2) * L);
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Frequency (f)") {
                        return `
                            \\begin{align*}
                            f &= \\frac{1}{2 \\pi \\sqrt{L C}} \\\\
                            f &= \\frac{1}{2 \\pi \\sqrt{${formatNumberWithUnit(inputs["Inductance (L)"], 'L')} \\times ${formatNumberWithUnit(inputs["Capacitance (C)"], 'C')}}} \\\\
                            f &= ${formatNumberWithUnit(result, 'f')}
                            \\end{align*}
                        `;
                    } else if (missing === "Inductance (L)") {
                        return `
                            \\begin{align*}
                            L &= \\frac{1}{(2 \\pi f)^2 C} \\\\
                            L &= \\frac{1}{(2 \\pi \\times ${formatNumberWithUnit(inputs["Frequency (f)"], 'f')})^2 \\times ${formatNumberWithUnit(inputs["Capacitance (C)"], 'C')}} \\\\
                            L &= ${formatNumberWithUnit(result, 'L')}
                            \\end{align*}
                        `;
                    } else if (missing === "Capacitance (C)") {
                        return `
                            \\begin{align*}
                            C &= \\frac{1}{(2 \\pi f)^2 L} \\\\
                            C &= \\frac{1}{(2 \\pi \\times ${formatNumberWithUnit(inputs["Frequency (f)"], 'f')})^2 \\times ${formatNumberWithUnit(inputs["Inductance (L)"], 'L')}} \\\\
                            C &= ${formatNumberWithUnit(result, 'C')}
                            \\end{align*}
                        `;
                    }
                }
            },
            quality_factor: {
                name: "Quality Factor",
                category: "Resonance and Filter Design",
                variables: ["Resonant Frequency (f_r)", "Bandwidth (Δf)", "Quality Factor (Q)"],
                formula: "Q = \\frac{f_r}{\\Delta f}",
                calculate: function(inputs, missing) {
                    const f_r = parseFloat(inputs["Resonant Frequency (f_r)"]);
                    const delta_f = parseFloat(inputs["Bandwidth (Δf)"]);
                    const Q = parseFloat(inputs["Quality Factor (Q)"]);

                    if (missing === "Quality Factor (Q)") {
                        return f_r / delta_f;
                    } else if (missing === "Resonant Frequency (f_r)") {
                        return Q * delta_f;
                    } else if (missing === "Bandwidth (Δf)") {
                        return f_r / Q;
                    } else {
                        throw new Error("Please leave one field empty to calculate.");
                    }
                },
                explanation: function(inputs, result, missing) {
                    if (missing === "Quality Factor (Q)") {
                        return `
                            \\begin{align*}
                            Q &= \\frac{f_r}{\\Delta f} \\\\
                            Q &= \\frac{${formatNumberWithUnit(inputs["Resonant Frequency (f_r)"], 'f_r')}}{${formatNumberWithUnit(inputs["Bandwidth (Δf)"], 'Δf')}} \\\\
                            Q &= ${formatNumberWithUnit(result, 'Q')}
                            \\end{align*}
                        `;
                    } else if (missing === "Resonant Frequency (f_r)") {
                        return `
                            \\begin{align*}
                            f_r &= Q \\times \\Delta f \\\\
                            f_r &= ${formatNumberWithUnit(inputs["Quality Factor (Q)"], 'Q')} \\times ${formatNumberWithUnit(inputs["Bandwidth (Δf)"], 'Δf')} \\\\
                            f_r &= ${formatNumberWithUnit(result, 'f_r')}
                            \\end{align*}
                        `;
                    } else if (missing === "Bandwidth (Δf)") {
                        return `
                            \\begin{align*}
                            \\Delta f &= \\frac{f_r}{Q} \\\\
                            \\Delta f &= \\frac{${formatNumberWithUnit(inputs["Resonant Frequency (f_r)"], 'f_r')}}{${formatNumberWithUnit(inputs["Quality Factor (Q)"], 'Q')}} \\\\
                            \\Delta f &= ${formatNumberWithUnit(result, 'Δf')}
                            \\end{align*}
                        `;
                    }
                }
            },
            // Add more calculators as per the categories...
        };

        let currentCalculation = 'ohms_law'; // Default calculation

        // History and Favorites
        let history = [];
        let favorites = [];

        // Timer for debouncing history entries
        let historyTimer = null;

        // Initialize Calculator
        window.onload = function() {
            renderCalculationButtons();
            renderInputs(currentCalculation);
            loadHistory();
            loadFavorites();
            runCalculation(); // Initialize with default calculation
        };

        // Function to render calculation buttons with categories
        function renderCalculationButtons() {
            const calculationButtonsDiv = document.getElementById('calculationButtons');
            calculationButtonsDiv.innerHTML = ''; // Clear existing buttons

            // Collect categories
            const categories = {};
            for (const key in calculations) {
                const calc = calculations[key];
                if (!categories[calc.category]) {
                    categories[calc.category] = [];
                }
                categories[calc.category].push({ key: key, name: calc.name });
            }

            // Render categories and buttons
            for (const category in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.classList.add('category');

                const h2 = document.createElement('h2');
                h2.innerText = category;
                categoryDiv.appendChild(h2);

                const buttonsDiv = document.createElement('div');
                buttonsDiv.classList.add('category-buttons');

                categories[category].forEach(calc => {
                    const button = document.createElement('button');
                    button.classList.add('calc-btn');
                    if (calc.key === currentCalculation) {
                        button.classList.add('active');
                    }
                    button.setAttribute('onclick', `selectCalculation('${calc.key}')`);
                    button.innerHTML = `<i class="fas fa-calculator"></i> ${calc.name}`;
                    buttonsDiv.appendChild(button);
                });

                categoryDiv.appendChild(buttonsDiv);
                calculationButtonsDiv.appendChild(categoryDiv);
            }
        }

        // Rest of the code remains the same...

        // Function to toggle dark mode
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const themeIcon = document.querySelector('.theme-toggle i');
            if (document.body.classList.contains('dark-mode')) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        // Function to select a calculation from buttons
        function selectCalculation(calculationKey) {
            currentCalculation = calculationKey;
            renderCalculationButtons();
            renderInputs(calculationKey);
            runCalculation();
        }

        // Function to render input fields based on calculation
        function renderInputs(calculationKey) {
            // Existing code for rendering inputs...
            const inputGroupDiv = document.getElementById('inputGroup');
            inputGroupDiv.innerHTML = ''; // Clear previous inputs

            const calculation = calculations[calculationKey];
            const variables = calculation.variables;

            if (calculationKey === 'resistance_series' || calculationKey === 'resistance_parallel') {
                // Existing code for dynamic resistor inputs...
                // No changes needed here
            } else {
                // For standard and new calculations, render inputs as defined with proper subscripts
                variables.forEach(variable => {
                    const div = document.createElement('div');
                    div.classList.add('input-group');

                    const label = document.createElement('label');
                    label.setAttribute('for', variable);
                    // Replace underscores with <sub> tags for proper subscript formatting
                    const formattedLabel = variable.replace(/_([A-Za-z]+)/g, '<sub>$1</sub>');
                    label.innerHTML = `${formattedLabel}:`;

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = variable;
                    input.placeholder = `Enter ${variable.replace(/_([A-Za-z]+)/g, '$1')}`; // Remove underscores in placeholder
                    input.min = "0"; // Ensure positive inputs where applicable
                    input.oninput = runCalculation;

                    div.appendChild(label);
                    div.appendChild(input);
                    inputGroupDiv.appendChild(div);
                });
            }
        }

        // Rest of the JavaScript code remains the same...

        // Continue with the functions: runCalculation, getUnitSymbol, formatNumberWithUnit, etc.

    </script>
</body>
</html>
